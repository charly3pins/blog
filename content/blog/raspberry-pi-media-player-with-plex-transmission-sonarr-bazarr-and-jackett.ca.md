+++
title = "Reproductor multim√®dia a un Raspberry Pi amb Plex, Transmission, Sonarr, Bazarr i Jackett"
date = "2020-11-05"
author = "charly3pins"
description = "Constru√Øu el vostre propi reproductor multim√®dia mitjan√ßant un client BitTorrent (transmissi√≥), un PVR per a usuaris d‚ÄôUsenet i BitTorrent (Sonarr), un suport d‚ÄôAPI per als vostres seguidors de torrents (Jackett), un gestor de subt√≠tols a Sonarr & Radarr (Bazarr) i un client‚Äìservudir reproductor multim√®dia (Plex)."

slug = "Reproductor multim√®dia a un Raspberry Pi amb Plex, Transmission, Sonarr, Bazarr i Jackett"
section = "/blog"
tags = ["raspberry-pi", "linux", "life"]

image = "/images/raspberry-media-player/cover.png"
+++

Aix√≠ que teniu una Raspberry Pi abandonada i sempre heu volgut utilitzar-lo per a alguna cosa √∫til. Tamb√© us agrada veure s√®ries, per√≤ hi ha massa prove√Ødors i no sabeu quin se‚Äôn subscriu. No us preocupeu amb aquest tutorial, tindreu solucionats tots dos problemes alhora; Utilitzar√† el Raspberry Pi per veure la vostra s√®rie preferida sense l√≠mits.

## Instal¬∑leu el sistema operatiu Raspberry

Primer de tot, hem d‚Äôinstal¬∑lar un sistema operatiu al nostre Raspberry. Per aix√≤, tenim diferents opcions explicades a la [documentaci√≥ oficial](https://www.raspberrypi.org/downloads/raspberry-pi-os/). Personalment, vaig decidir el sistema operatiu "Raspberry Pi (32 bits) Lite", ja que no vull cap escriptori ni cap programari recomanat, de manera que com m√©s lleuger millor.

Des de la [font](https://www.raspberrypi.org/documentation/installation/installing-images/) seguim les instruccions de la imatge de Linux.

Com ja sabeu, necessitem una microSD per executar el sistema operatiu en un Raspberry Pi, de manera que ens hem de connectar al nostre ordinador port√†til i saber-ne el nom. Per a aix√≤ podem obrir un terminal i escriure:
```vim
lsblk -p
```
En el meu cas √©s `/dev/sda`.

Un cop sabem el nom de la SD, hem d‚Äôescriure la imatge a la targeta amb l‚Äôordre seg√ºent, assegurant-nos que substitu√Øu l‚Äôargument d‚Äôentrada `if =` pel cam√≠ del fitxer .img i el fitxer `/dev/sda` argument al fitxer de sortida `of=`amb el nom del dispositiu correcte.

‚ö†Ô∏è Aix√≤ √©s molt important, ja que perdeu totes les dades del disc dur si proporcioneu un nom de dispositiu incorrecte. Assegureu-vos que el nom del dispositiu sigui el nom de tota la targeta SD tal com s‚Äôha descrit anteriorment, no nom√©s una partici√≥. Per exemple: sdd, no sdds1 o sddp1; mmcblk0, no mmcblk0p1.

```vim
sudo dd bs=4M if=2020-08-20-raspios-buster-armhf-lite.img of=/dev/sda conv=fsyn
```

Podem afegir els indicadors `status=progress conv=fsync` per veure el progr√©s:
```vim
dd bs=4M if=2020-08-20-raspios-buster-armhf.img of=/dev/sda status=progress conv=fsync
```

Si est√† comprimit, podem concatenar les ordres descomprimir i dd amb:
```vim
sudo unzip -p 2020-08-20-raspios-buster-armhf.zip | sudo dd of=/dev/sda bs=4M conv=fsync
```

Despr√©s d‚Äôaix√≤, ja tenim el nostre sistema operatiu instal¬∑lat a la microSD, de manera que tenim el nostre Raspberry Pi a punt. üôå

### Iniciar Sessi√≥

Ara √©s el moment per tornar a inserir la microSD al Raspberry, connectar-la a la pantalla i connectar-la.

Al nostre televisor apareix una cosa aix√≠:

![installation](/images/raspberry-media-player/installation.jpg)

Com podeu observar a la part inferior, ja he iniciat la sessi√≥. L'usuari √©s `pi` i la contrasenya per defecte `raspberry`. Es recomana canviar la contrasenya la primera vegada que inicieu la sessi√≥.

## Activa ssh

El seg√ºent pas √©s habilitar la connexi√≥ ssh, ja que volem gestionar el Raspberry des del nostre ordinador port√†til, no des del televisor, aix√≠ que primer llegiu la [documentaci√≥](https://www.raspberrypi.org/documentation/remote-access/ssh/ ).

El segon √©s utilitzar el sistema systeml per iniciar i habilitar el servei:
```vim
sudo systemctl start ssh
```
```vim
sudo systemctl enable ssh
```

Podem comprovar si funciona amb:
```vim
sudo systemctl status ssh
```

I apareixer√† com:
```vim
‚óè ssh.service - OpenBSD Secure Shell server
   Loaded: loaded (/lib/systemd/system/ssh.service; enabled; vendor preset: enabled)
   Active: active (running) since XXX
     Docs: man:sshd(8)
           man:sshd_config(5)
 Main PID: 440 (sshd)
    Tasks: 1 (limit: 2063)
   CGroup: /system.slice/ssh.service
           ‚îî‚îÄ440 /usr/sbin/sshd -D

```

Despr√©s d'aix√≤, hem de descobrir la `IP` del nostre Raspberry. Per a aix√≤ podem utilitzar:
```vim
ifconfig
```

I apareixer√† una cosa aix√≠:
![ifconfig](/images/raspberry-media-player/ifconfig.jpg)

En el meu cas, podeu veure que √©s `192.168.1.131`, aix√≠ que ho utilitzar√© com a refer√®ncia; el vostre probablement ser√† diferent perqu√® dep√®n de la vostra xarxa.

Ara podem anar al nostre ordinador port√†til i connectar-nos mitjan√ßant ssh:
```vim
ssh pi@192.168.1.131
```

Us demanar√† la contrasenya, per√≤ ja sabem quina √©s perqu√® hem iniciat la sessi√≥ directament al gerd (recordeu que la canvieu üòú).

## Configureu una unitat USB com a emmagatzematge de suports

Primer volem actualitzar i tenir les darreres depend√®ncies, aix√≠ que escriviu:
```vim
sudo apt-get update
sudo apt-get upgrade
```

Vaig decidir utilitzar una unitat USB formatada com a ExFAT, ja que nom√©s treballo amb Linux. Connecteu la unitat USB al Raspberry Pi i reinicieu-la.

Des del terminal executeu:

```vim
sudo fdisk -l
```

En qu√® es mostraran totes les particions reconegudes pel sistema. Identifiqueu l‚Äôassociat amb la unitat externa. En el meu cas √©s:
```vim
Disk /dev/sda: 1.8 TiB, 2000398934016 bytes, 3907029168 sectors
Disk model: External USB 3.0
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x0072438b

Device     Boot Start        End    Sectors  Size Id Type
/dev/sda1        2048 3907028991 3907026944  1.8T  7 HPFS/NTFS/exFAT
```

Ara instal¬∑leu els controladors exFAT, en cas contrari no es reconeixer√† el sistema de fitxers:
```vim
sudo apt-get install exfat-fuse
```

I creeu el directori on es muntar√† el disc:
```vim
sudo mkdir /media/storage
```

Ara podem muntar el disc amb:
```vim
sudo mount /dev/sda1 /media/storage
```
‚ö†Ô∏è Recordeu que heu de substituir `sda1` pel nom del dispositiu real que heu trobat amb sudo fdisk -l.

Per desmuntar-lo podem utilitzar:
```vim
sudo umount /media/storage
```

Idealment, volem que la unitat estigui sempre connectada, de manera que configurem la muntura a l‚Äôarrencada i la desem per escriure aquestes ordres cada vegada que reiniciem el gerd.

Primer trobem l‚Äôidentificador:
```vim
sudo blkid
```

En el meu cas el resultat √©s:

```vim
/dev/mmcblk0p1: LABEL_FATBOOT="boot" LABEL="boot" UUID="4AD7-B4D5" TYPE="vfat" PARTUUID="d5603eaf-01"
/dev/mmcblk0p2: LABEL="rootfs" UUID="2887d26c-6ae7-449d-9701-c5a4018755b0" TYPE="ext4" PARTUUID="d5603eaf-02"
/dev/mmcblk0: PTUUID="d5603eaf" PTTYPE="dos"
/dev/sda1: UUID="1200CB0C6CE045EE" TYPE="ntfs" PTTYPE="atari" PARTUUID="0072438b-01"
```

El que ens interessa √©s el UUID de la nostra unitat externa. En el meu cas, aix√≤ √©s `1200CB0C6CE045EE`.

Ara podem editar el fitxer:
```vim
sudo nano /etc/fstab
```

I afegiu aquesta l√≠nia a la part inferior:
```
UUID=1200CB0C6CE045EE /media/storage exfat defaults,auto,umask=000,users,rw 0 0
```
‚ö†Ô∏è No oblideu substituir l‚ÄôUUID pel vostre.

## Transmissi√≥ BitTorrent

El seg√ºent pas √©s tenir un client BitTorrent per descarregar els torrents (nom√©s els legals, per descomptat) i, per a aix√≤, haur√≠em d'instal¬∑lar `Transmission`.

Executeu l'ordre seg√ºent:
```vim
sudo apt-get install -y transmission-daemon transmission-cli transmission-common
```

Novetat, hem d‚Äôaturar el dimoni per aplicar canvis a la configuraci√≥ que ens permetran gestionar-la remotament:
```vim
sudo service transmission-daemon stop
sudo vi /etc/transmission-daemon/settings.json
``

Cerqueu rpc-whitelist i rpc-whitelist-enabled i assegureu-vos que tinguin aquest aspecte:
```vim
"rpc-whitelist": "127.0.0.1,192.168.*.*",
"rpc-whitelist-enable": "true",
```

Tingueu en compte que aix√≤ suposa que la vostra xarxa interna funciona el `192.168.0.1/24`. En cas contrari, canvieu el valor en conseq√º√®ncia.

Tamb√© podem modificar dir-descarregar i dir-incomplet per apuntar cap a la unitat USB externa, per exemple:
```vim
"download-dir": "/media/storage/downloads",
"incomplete-dir": "/media/storage/.tmp",
"incomplete-dir-enabled": true,
```

Assegureu-vos que els directoris existeixen a la vostra unitat USB externa (hem creat a la secci√≥ anterior).

Configureu l'usuari i la contrasenya:
```vim  
"rpc-password": "superSecret",
"rpc-port": 9091,
"rpc-url": "/transmission/",
"rpc-username": "gopher",
```

El seg√ºent pas √©s canviar el port de parells perqu√® de vegades el vostre prove√Ødor bloquejar√† el port per defecte. Podeu seleccionar el que vulgueu entre el rang 49152-65535. En el meu cas, vaig decidir utilitzar el 51228. Trobeu la seg√ºent l√≠nia:
```vim
"peer-port": 51413,
```

I canvieu-lo pel port decidit:
```vim
"peer-port": 51228,
```

Tamb√© podeu gestionar la velocitat de desc√†rrega/c√†rrega des de la configuraci√≥ editant les l√≠nies seg√ºents:
```vim
"speed-limit-down": 3000,
"speed-limit-down-enabled": true,
"speed-limit-up": 900,
"speed-limit-up-enabled": true,
```

Ara podem tornar a iniciar el servei:
```vim
sudo service transmission-daemon start
```

La interf√≠cie web ja est√† disponible a l‚Äôadre√ßa http://192.168.1.131:9091 (substitu√Øu l‚Äôadre√ßa IP per l‚Äôutilitzada per Raspberry Pi a la vostra xarxa).

Podeu iniciar sessi√≥ amb el nom d'usuari i la contrasenya com a `transmission`.

## Instal¬∑leu Sonarr

[Sonarr](https://github.com/Sonarr/Sonarr) √©s un PVR per a usuaris d‚ÄôUsenet i BitTorrent. Pot controlar diversos canals RSS de cap√≠tols nous dels vostres programes preferits i els agafar√†, ordenar√† i canviar√† el nom. Tamb√© es pot configurar per actualitzar autom√†ticament la qualitat dels fitxers ja descarregats quan es disposa d‚Äôun format de millor qualitat.

Hem d‚Äôinstal¬∑lar depend√®ncies com ara `libmono-cil-dev` i `mono 3.10`. He utilitzat aquest [enlla√ß](https://www.htpcguides.com/install-sonarr-raspberry-pi-mono-310/) com a refer√®ncia. Per a aix√≤, hem d'escriure:
```vim
sudo apt-get install libmono-cil-dev
wget http://sourceforge.net/projects/bananapi/files/mono_3.10-armhf.deb
sudo dpkg -i mono_3.10-armhf.deb
```

Despr√©s d'aix√≤, podem instal¬∑lar Sonarr:
```vim
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 0xA236C58F409091A18ACA53CBEBFF6B99D9B78493
echo "deb http://apt.sonarr.tv/ master main" | sudo tee /etc/apt/sources.list.d/sonarr.list
sudo apt-get update
sudo apt-get install nzbdrone
sudo chown -R pi:pi /opt/NzbDrone
```

### Script d‚Äôinici autom√†tic

Hem de crear el fitxer `/ etc/systemd/system/nzbdrone.service`:
```vim
sudo nano /etc/systemd/system/nzbdrone.service
```

I posar a dins:
```vim
[Unit]
Description=Sonarr Daemon
After=network.target

[Service]
User=pi
Group=pi

Type=simple
ExecStart=/usr/bin/mono /opt/NzbDrone/NzbDrone.exe -nobrowser
TimeoutStopSec=20
KillMode=process
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

Podem iniciar, comprovar l‚Äôestat i habilitar si el servei funciona amb les comandes seg√ºents, respectivament:
```vim
sudo systemctl start nzbdrone
sudo systemctl status nzbdrone
sudo systemctl enable nzbdrone
```

La interf√≠cie web ja est√† disponible a l'adre√ßa http://192.168.1.131:8989 (substitu√Øu l'adre√ßa IP per la que utilitza Raspberry Pi a la vostra xarxa).

##  Instal¬∑leu Jackett

[Jackett](https://github.com/Jackett/Jackett) funciona com a servidor intermediari: tradueix les consultes d'aplicacions (Sonarr, Radarr, SickRage, CouchPotato, Mylar, Lidarr, DuckieTV, qBittorrent, Nefarious, etc.) al rastrejador -consultes http espec√≠fiques del lloc, analitza la resposta html i torna els resultats al programari sol¬∑licitant. Aix√≤ permet obtenir c√†rregues recents (com RSS) i realitzar cerques. Jackett √©s un dip√≤sit √∫nic de l√≤gica de traducci√≥ i rascat d‚Äôindexadors mantinguda, que elimina la c√†rrega d‚Äôaltres aplicacions.

Comencem a descarregar la versi√≥ m√©s recent de Jackett:
```vim
wget -q https://github.com/Jackett/Jackett/releases/latest -O - | grep -E \/tag\/ | awk -F "[><]" '{print $3}'
```

O si ja coneixeu la versi√≥:
```vim
wget -q https://github.com/Jackett/Jackett/releases/download/v0.16.1937/Jackett.Binaries.LinuxARM32.tar.gz
```

A continuaci√≥, hem de descomprimir el fitxer i moure'l al directori correcte:
```vim
tar zxvf Jackett.Binaries.LinuxARM32.tar.gz 
sudo mv Jackett /opt/
```

Canvieu la propietat de Jackett a l'usuari principal del Raspberry Pi, que en el nostre cas √©s `pi`:
```vim
sudo chown -R pi:pi /opt/Jackett
```

### Script d‚Äôinici autom√†tic

Hem de crear el fitxer `/etc/systemd/system/jackett.service`:
```vim
sudo nano /etc/systemd/system/jackett.service
```

I posar a dins:
```vim
[Unit]
Description=Jackett Daemon
After=network.target

[Service]
SyslogIdentifier=jackett
Restart=always
RestartSec=5
Type=simple
User=pi
Group=pi
WorkingDirectory=/opt/Jackett
ExecStart=/opt/Jackett/jackett --NoRestart
TimeoutStopSec=20

[Install]
WantedBy=multi-user.target
```

Podem iniciar, comprovar l‚Äôestat i habilitar si el servei funciona amb les comandes seg√ºents, respectivament:
```vim
sudo systemctl start jackett
sudo systemctl status jackett
sudo systemctl enable jackett
```

La interf√≠cie web ja est√† disponible a l'adre√ßa http://192.168.1.131:9117 (substitu√Øu l'adre√ßa IP per la que utilitza Raspberry Pi a la vostra xarxa).

## Instal¬∑leu Bazarr

[Bazarr](https://github.com/morpheus65535/bazarr) √©s una aplicaci√≥ complement√†ria per a Sonarr i Radarr. Gestiona i descarrega subt√≠tols segons els vostres requisits. Definiu les vostres prefer√®ncies mitjan√ßant programes de televisi√≥ o pel¬∑l√≠cules i Bazarr s‚Äôencarregar√† de tot per vosaltres.

Com a depend√®ncia d‚Äôaix√≤, haur√≠em d‚Äôinstal¬∑lar `python3`. Primer de tot, fem aix√≤:
```vim
sudo apt-get install python3 idle3
``` 

A continuaci√≥, hem de tenir git per descarregar el repo i el pip per gestionar la instal¬∑laci√≥ del paquet:
```vim
sudo apt-get install git python3-pip python3-distutils
```

Ara √©s hora d‚Äôinstal¬∑lar les depend√®ncies de Bazaar:
```vim
sudo apt-get install libxml2-dev libxslt1-dev python3-libxml2 python3-lxml unrar-free ffmpeg libatlas-base-dev
```

Amb aix√≤, estem preparats per instal¬∑lar Bazarr al nostre gerd. Hem de clonar el repo directament des de GitHub mitjan√ßant git i ho fem directament a la carpeta de destinaci√≥ `opt/bazarr` escrivint l'ordre seg√ºent:
```vim
sudo git clone https://github.com/morpheus65535/bazarr.git /opt/bazarr
```

A continuaci√≥, hem d‚Äôanar a aquesta carpeta i instal¬∑lar els requisits definits al seu interior amb:
```vim
cd /opt/bazarr
python3 -m pip install -r requirements.txt
```
‚ÑπÔ∏è NOTA: No us preocupeu perqu√® no s'instal¬∑li `lxml` en aquest pas, heu instal¬∑lat el m√≤dul a trav√©s d'apt-get de totes maneres.

Canvieu la propietat per l'usuari `pi`:
```vim
sudo chown -R pi:pi /opt/bazarr
```

I podem comen√ßar i provar Bazaar:
```vim
python3 bazarr.py 
```

Despr√©s dels missatges d'inici i configuraci√≥ de Bazarr, comproveu si funciona a http://192.168.1.131:6767/.

### Connecta amb Sonarr

El seg√ºent pas √©s connectar-lo amb Sonarr. La [documentaci√≥ oficial](https://github.com/morpheus65535/bazarr/wiki/Setup-Guide) √©s molt senzilla i f√†cil de seguir, aix√≠ que no la posar√© aqu√≠. Nom√©s una cosa que no √©s prou clara com a m√≠nim per a mi i que es tracta de la clau API Sonarr i de la seva ubicaci√≥, aix√≠ que, com a consell, posar√© aqu√≠ que:

- La clau de l'API Sonarr es troba a `Settings/General/Security`

### Script d‚Äôinici autom√†tic

Hem de crear el fitxer `/etc/systemd/system/bazarr.service`:
```vim
sudo nano /etc/systemd/system/bazarr.service
```

I posar a dins:
```vim
[Unit]
Description=Bazarr Daemon
After=syslog.target network.target

# After=syslog.target network.target sonarr.service radarr.service

[Service]
WorkingDirectory=/opt/bazarr/
User=pi
Group=pi
UMask=0002
Restart=on-failure
RestartSec=5
Type=simple
ExecStart=/usr/bin/python3 /opt/bazarr/bazarr.py
KillSignal=SIGINT
TimeoutStopSec=20
SyslogIdentifier=bazarr
ExecStartPre=/bin/sleep 30

[Install]
WantedBy=multi-user.target
```

Podem iniciar, comprovar l‚Äôestat i habilitar si el servei funciona amb les comandes seg√ºents, respectivament:
```vim
sudo systemctl start bazarr
sudo systemctl status bazarr
sudo systemctl enable bazarr
```

La interf√≠cie web ja est√† disponible a l'adre√ßa http://192.168.1.131:6767 (substitu√Øu l'adre√ßa IP per la que utilitza Raspberry Pi a la vostra xarxa).

## Instal¬∑leu Plex

[Plex] (https://www.plex.tv/) reuneix tots els mitjans que us importen. La vostra col¬∑lecci√≥ personal quedar√† bonica al costat del contingut de transmissi√≥ estel¬∑lar. Gaudeix de TV i DVR en directe, un cat√†leg creixent de grans programes web, not√≠cies i podcasts. Finalment √©s possible gaudir de tots els suports que m√©s t‚Äôagraden en una sola aplicaci√≥, en qualsevol dispositiu, independentment d‚Äôon siguis.

Primer de tot, hem d‚Äôafegir un nou repositori i √©s clau. Aix√≤ afegir√† al sistema operatiu de Raspberry els repositoris on hem de descarregar la instal¬∑laci√≥ i les futures actualitzacions. √âs com una llista d‚Äôenlla√ßos on el sistema llegeix autom√†ticament els programes que necessita per a la instal¬∑laci√≥ i les actualitzacions.
```vim
echo deb https://downloads.plex.tv/repo/deb public main | sudo tee /etc/apt/sources.list.d/plexmediaserver.list
```

El seg√ºent pas √©s afegir les signatures dels repos. El sistema ha de garantir que els repos que hem afegit manualment siguin correctes i que no tinguin programari malici√≥s. Per a aix√≤, hem d'afegir la clau i el sistema d'ajuda per verificar aquests repos.
```vim
curl https://downloads.plex.tv/plex-keys/PlexSign.key | sudo apt-key add
```

Ara podem actualitzar la nostra llista de paquets i instal¬∑lar Plex Media Server:
```vim
sudo apt-get update
sudo apt-get install plexmediaserver
```

Podeu completar la configuraci√≥ obrint el seg√ºent enlla√ß amb el vostre navegador:

La interf√≠cie web ja est√† disponible a l'adre√ßa http://192.168.0.10:32400/web (substitu√Øu l'adre√ßa IP per la que utilitza Raspberry Pi a la vostra xarxa).

Quan se us demani que afegiu biblioteques, haureu d'afegir la carpeta de desc√†rrega de Transmission, al nostre exemple `/media/storage/downloads`.

I simplement a gaudir del reproductor multim√®dia amb la teva s√®rie preferida üì∫.

Si tamb√© esteu interessats en pel¬∑l√≠cules, podeu instal¬∑lar [Radarr](https://github.com/Radarr/Radarr), que √©s un fork independent de Sonarr reelaborada per descarregar autom√†ticament pel¬∑l√≠cules a trav√©s d‚ÄôUsenet i BitTorrent. El projecte es va inspirar en altres descarregadors de pel¬∑l√≠cules Usenet/BitTorrent com CouchPotato.

En una publicaci√≥ futura probablement intenti Dockerize tota aquesta configuraci√≥ i inclour√© Radarr, o no... ja ho veurem üßë‚ÄçüöÄ

Espero que us hagi agradat i si teniu dubtes, contacteu amb mi a qualsevol xarxa social.